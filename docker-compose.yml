version: '3.8'

services:
  # =============================================
  # 后端应用服务
  # =============================================
  storyweaver-app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: storyweaver-app
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3000
      - AI_PROVIDER=${AI_PROVIDER:-deepseek}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - QWEN_API_KEY=${QWEN_API_KEY:-}
      - QWEN_BASE_URL=${QWEN_BASE_URL:-https://dashscope.aliyuncs.com}
      - LOCAL_AI_URL=${LOCAL_AI_URL:-http://localhost:11434}
      - LOCAL_AI_MODEL=${LOCAL_AI_MODEL:-deepseek-chat}
      - DB_PATH=/app/data/storyweaver.db
      - SCRIPT_FACTORY_DB_PATH=/app/data/scripts.db
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - storyweaver-data:/app/data
      - storyweaver-logs:/app/logs
      # 挂载后端代码目录，实现代码热更新（生产环境）
      - ./backend:/app/backend:ro
    networks:
      - storyweaver-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    # 不直接暴露端口，由 Nginx 代理
    expose:
      - "3000"

  # =============================================
  # Nginx 反向代理
  # =============================================
  nginx:
    image: nginx:alpine
    container_name: storyweaver-nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/logs:/var/log/nginx
      - storyweaver-static:/usr/share/nginx/html:ro
      # SSL证书目录（可选）
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      storyweaver-app:
        condition: service_healthy
    networks:
      - storyweaver-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  # =============================================
  # 静态文件初始化容器
  # =============================================
  static-init:
    build:
      context: .
      dockerfile: Dockerfile
      target: frontend-build
    container_name: storyweaver-static-init
    volumes:
      - storyweaver-static:/output
      # 挂载前端源代码，使用最新的代码进行构建
      - ./frontend:/app/frontend
    command: sh -c "cd /app/frontend && npm install --silent && npm run build && cp -r dist/* /output/ && echo 'Static files built and copied successfully'"
    networks:
      - storyweaver-network

# =============================================
# 数据卷
# =============================================
volumes:
  storyweaver-data:
    driver: local
  storyweaver-logs:
    driver: local
  storyweaver-static:
    driver: local

# =============================================
# 网络
# =============================================
networks:
  storyweaver-network:
    driver: bridge

