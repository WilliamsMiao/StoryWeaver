<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰§æœ¬å·¥å‚ - ç®¡ç†åå°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans SC', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 100%); }
    .card { backdrop-filter: blur(10px); background: rgba(255,255,255,0.1); }
    .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
    .sidebar { width: 260px; }
    .main-content { margin-left: 260px; }
    .status-draft { color: #fbbf24; }
    .status-ready { color: #34d399; }
    .status-published { color: #60a5fa; }
    .modal { display: none; }
    .modal.active { display: flex; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 12px; }
    /* ç»ˆç«¯æ ·å¼ */
    .terminal {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      line-height: 1.5;
      color: #c9d1d9;
      overflow: hidden;
    }
    .terminal-header {
      background: #161b22;
      padding: 8px 12px;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .terminal-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .terminal-dot.red { background: #ff5f56; }
    .terminal-dot.yellow { background: #ffbd2e; }
    .terminal-dot.green { background: #27c93f; }
    .terminal-body {
      padding: 12px;
      height: 500px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    .terminal-line {
      margin: 2px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .terminal-line.info { color: #58a6ff; }
    .terminal-line.success { color: #3fb950; }
    .terminal-line.warning { color: #d29922; }
    .terminal-line.error { color: #f85149; }
    .terminal-line.ai { color: #a371f7; }
    .terminal-line.step { color: #79c0ff; font-weight: bold; }
    .terminal-line.timestamp { color: #8b949e; }
    .terminal-cursor {
      display: inline-block;
      width: 8px;
      height: 14px;
      background: #c9d1d9;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
  </style>
</head>
<body class="gradient-bg min-h-screen text-white">
  <!-- ä¾§è¾¹æ  -->
  <aside class="sidebar fixed left-0 top-0 h-full bg-gray-900/50 border-r border-gray-700 p-4">
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-purple-400">ğŸ­ å‰§æœ¬å·¥å‚</h1>
      <p class="text-sm text-gray-400 mt-1">Script Factory</p>
    </div>
    
    <nav class="space-y-2">
      <a href="#" onclick="showPage('dashboard')" class="nav-link flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700/50 transition" data-page="dashboard">
        <span>ğŸ“Š</span> ä»ªè¡¨ç›˜
      </a>
      <a href="#" onclick="showPage('scripts')" class="nav-link flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700/50 transition" data-page="scripts">
        <span>ğŸ“œ</span> å‰§æœ¬ç®¡ç†
      </a>
      <a href="#" onclick="showPage('generate')" class="nav-link flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700/50 transition" data-page="generate">
        <span>âœ¨</span> ç”Ÿæˆå‰§æœ¬
      </a>
      <a href="#" onclick="showPage('templates')" class="nav-link flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700/50 transition" data-page="templates">
        <span>ğŸ“</span> ä¸»é¢˜æ¨¡æ¿
      </a>
    </nav>
    
    <div class="absolute bottom-4 left-4 right-4">
      <div class="p-3 bg-gray-800/50 rounded-lg text-sm">
        <p class="text-gray-400">API ç«¯ç‚¹</p>
        <p class="text-gray-300 font-mono text-xs mt-1" id="apiEndpoint">http://localhost:3000</p>
      </div>
    </div>
  </aside>
  
  <!-- ä¸»å†…å®¹åŒº -->
  <main class="main-content p-8">
    <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
    <div id="page-dashboard" class="page">
      <h2 class="text-3xl font-bold mb-6">ğŸ“Š ä»ªè¡¨ç›˜</h2>
      
      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card rounded-xl p-6 border border-gray-700">
          <div class="text-3xl mb-2" id="stat-total">0</div>
          <div class="text-gray-400">æ€»å‰§æœ¬æ•°</div>
        </div>
        <div class="card rounded-xl p-6 border border-gray-700">
          <div class="text-3xl mb-2 text-green-400" id="stat-published">0</div>
          <div class="text-gray-400">å·²å‘å¸ƒ</div>
        </div>
        <div class="card rounded-xl p-6 border border-gray-700">
          <div class="text-3xl mb-2 text-yellow-400" id="stat-draft">0</div>
          <div class="text-gray-400">è‰ç¨¿</div>
        </div>
        <div class="card rounded-xl p-6 border border-gray-700">
          <div class="text-3xl mb-2 text-blue-400" id="stat-plays">0</div>
          <div class="text-gray-400">æ€»æ¸¸ç©æ¬¡æ•°</div>
        </div>
      </div>
      
      <!-- å¿«é€Ÿæ“ä½œ -->
      <div class="card rounded-xl p-6 border border-gray-700 mb-8">
        <h3 class="text-xl font-bold mb-4">ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
        <div class="flex gap-4">
          <button onclick="showPage('generate')" class="btn-primary px-6 py-3 rounded-lg font-bold transition transform hover:scale-105">
            âœ¨ ç”Ÿæˆæ–°å‰§æœ¬
          </button>
          <button onclick="loadScripts()" class="px-6 py-3 rounded-lg font-bold bg-gray-700 hover:bg-gray-600 transition">
            ğŸ”„ åˆ·æ–°æ•°æ®
          </button>
        </div>
      </div>
      
      <!-- æœ€è¿‘å‰§æœ¬ -->
      <div class="card rounded-xl p-6 border border-gray-700">
        <h3 class="text-xl font-bold mb-4">ğŸ“œ æœ€è¿‘å‰§æœ¬</h3>
        <div id="recent-scripts" class="space-y-3">
          <p class="text-gray-400">åŠ è½½ä¸­...</p>
        </div>
      </div>
    </div>
    
    <!-- å‰§æœ¬ç®¡ç†é¡µé¢ -->
    <div id="page-scripts" class="page hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold">ğŸ“œ å‰§æœ¬ç®¡ç†</h2>
        <div class="flex gap-4">
          <select id="filter-status" onchange="loadScripts()" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-2">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="draft">è‰ç¨¿</option>
            <option value="ready">å¾…å‘å¸ƒ</option>
            <option value="published">å·²å‘å¸ƒ</option>
          </select>
          <select id="filter-theme" onchange="loadScripts()" class="bg-gray-800 border border-gray-600 rounded-lg px-4 py-2">
            <option value="">å…¨éƒ¨ä¸»é¢˜</option>
          </select>
        </div>
      </div>
      
      <div id="scripts-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <p class="text-gray-400">åŠ è½½ä¸­...</p>
      </div>
    </div>
    
    <!-- ç”Ÿæˆå‰§æœ¬é¡µé¢ -->
    <div id="page-generate" class="page hidden">
      <h2 class="text-3xl font-bold mb-6">âœ¨ ç”Ÿæˆæ–°å‰§æœ¬</h2>
      
      <div class="flex gap-6">
        <!-- å·¦ä¾§ï¼šç”Ÿæˆè¡¨å• -->
        <div class="card rounded-xl p-8 border border-gray-700 flex-1">
          <form id="generate-form" onsubmit="generateScript(event)">
            <!-- ä¸»é¢˜é€‰æ‹© -->
            <div class="mb-6">
              <label class="block text-lg font-bold mb-3">ğŸ­ é€‰æ‹©ä¸»é¢˜</label>
              <div id="theme-options" class="grid grid-cols-2 gap-4">
                <!-- åŠ¨æ€ç”Ÿæˆä¸»é¢˜é€‰é¡¹ -->
              </div>
            </div>
            
            <!-- ç©å®¶äººæ•° -->
            <div class="mb-6">
              <label class="block text-lg font-bold mb-3">ğŸ‘¥ ç©å®¶äººæ•°</label>
              <div class="flex gap-4">
                <input type="range" id="player-count" min="3" max="8" value="4" 
                       class="flex-1" oninput="updatePlayerCount(this.value)">
                <span id="player-count-display" class="text-xl font-bold w-12 text-center">4äºº</span>
              </div>
            </div>
            
            <!-- éš¾åº¦é€‰æ‹© -->
            <div class="mb-6">
              <label class="block text-lg font-bold mb-3">â­ éš¾åº¦ç­‰çº§</label>
              <div class="flex gap-2">
                <button type="button" onclick="selectDifficulty(1)" class="difficulty-btn px-4 py-2 rounded-lg bg-gray-700">ç®€å•</button>
                <button type="button" onclick="selectDifficulty(2)" class="difficulty-btn px-4 py-2 rounded-lg bg-gray-700">è¾ƒæ˜“</button>
                <button type="button" onclick="selectDifficulty(3)" class="difficulty-btn px-4 py-2 rounded-lg bg-purple-600">ä¸­ç­‰</button>
                <button type="button" onclick="selectDifficulty(4)" class="difficulty-btn px-4 py-2 rounded-lg bg-gray-700">è¾ƒéš¾</button>
                <button type="button" onclick="selectDifficulty(5)" class="difficulty-btn px-4 py-2 rounded-lg bg-gray-700">å›°éš¾</button>
              </div>
              <input type="hidden" id="difficulty" value="3">
            </div>
            
            <!-- è‡ªå®šä¹‰æ ‡é¢˜ -->
            <div class="mb-6">
              <label class="block text-lg font-bold mb-3">ğŸ“ å‰§æœ¬æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="custom-title" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ" 
                     class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3">
            </div>
            
            <!-- è‡ªå®šä¹‰èƒŒæ™¯ -->
            <div class="mb-8">
              <label class="block text-lg font-bold mb-3">ğŸ“– è‡ªå®šä¹‰èƒŒæ™¯ï¼ˆå¯é€‰ï¼‰</label>
              <textarea id="custom-background" rows="3" placeholder="è¾“å…¥è‡ªå®šä¹‰æ•…äº‹èƒŒæ™¯ï¼ŒAIå°†æ®æ­¤ç”Ÿæˆå‰§æœ¬..."
                        class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3"></textarea>
            </div>
            
            <!-- ç”ŸæˆæŒ‰é’® -->
            <button type="submit" id="generate-btn" class="w-full btn-primary py-4 rounded-lg text-xl font-bold transition transform hover:scale-105">
              ğŸ² å¼€å§‹ç”Ÿæˆå‰§æœ¬
            </button>
          </form>
          
          <!-- ç”Ÿæˆè¿›åº¦æ¡ -->
          <div id="generate-progress" class="hidden mt-6">
            <div class="flex items-center gap-4 mb-3">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500"></div>
              <span id="progress-text" class="text-purple-300">æ­£åœ¨ç”Ÿæˆå‰§æœ¬...</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div id="progress-bar" class="bg-purple-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="text-sm text-gray-400 mt-2" id="progress-step">å‡†å¤‡ä¸­...</div>
          </div>
        </div>
        
        <!-- å³ä¾§ï¼šå®æ—¶ç»ˆç«¯ -->
        <div class="terminal flex-1 min-w-[450px]">
          <div class="terminal-header">
            <div class="terminal-dot red"></div>
            <div class="terminal-dot yellow"></div>
            <div class="terminal-dot green"></div>
            <span class="text-gray-400 text-sm ml-2">ğŸ–¥ï¸ ç”Ÿæˆæ—¥å¿— - Terminal</span>
            <div class="ml-auto flex gap-2">
              <button onclick="copyTerminalContent()" class="text-gray-500 hover:text-gray-300 text-xs px-2 py-1 rounded bg-gray-800">
                ğŸ“‹ å¤åˆ¶
              </button>
              <button onclick="clearTerminal()" class="text-gray-500 hover:text-gray-300 text-xs px-2 py-1 rounded bg-gray-800">
                ğŸ—‘ï¸ æ¸…ç©º
              </button>
            </div>
          </div>
          <div class="terminal-body" id="terminal-output">
            <div class="terminal-line timestamp">[ç³»ç»Ÿ] ç»ˆç«¯å·²å°±ç»ªï¼Œç­‰å¾…ç”Ÿæˆä»»åŠ¡...</div>
            <div class="terminal-line info">ğŸ’¡ ç‚¹å‡»"å¼€å§‹ç”Ÿæˆå‰§æœ¬"åï¼Œè¿™é‡Œå°†å®æ—¶æ˜¾ç¤ºç”Ÿæˆè¿›åº¦å’ŒAIè¿”å›å†…å®¹</div>
            <div class="terminal-line"></div>
            <div class="terminal-line">
              <span class="terminal-cursor"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ä¸»é¢˜æ¨¡æ¿é¡µé¢ -->
    <div id="page-templates" class="page hidden">
      <h2 class="text-3xl font-bold mb-6">ğŸ“ ä¸»é¢˜æ¨¡æ¿</h2>
      
      <div id="templates-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </main>
  
  <!-- å‰§æœ¬è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div id="script-modal" class="modal fixed inset-0 bg-black/70 items-center justify-center z-50">
    <div class="bg-gray-900 rounded-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-700 flex justify-between items-center sticky top-0 bg-gray-900">
        <h3 id="modal-title" class="text-2xl font-bold">å‰§æœ¬è¯¦æƒ…</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="modal-content" class="p-6">
        <!-- åŠ¨æ€å†…å®¹ -->
      </div>
      <div class="p-6 border-t border-gray-700 flex gap-4">
        <button onclick="publishScript()" id="btn-publish" class="btn-primary px-6 py-3 rounded-lg font-bold">
          ğŸš€ å‘å¸ƒå‰§æœ¬
        </button>
        <button onclick="exportScript()" class="px-6 py-3 rounded-lg font-bold bg-gray-700 hover:bg-gray-600">
          ğŸ“¥ å¯¼å‡ºJSON
        </button>
        <button onclick="deleteScript()" class="px-6 py-3 rounded-lg font-bold bg-red-600 hover:bg-red-500">
          ğŸ—‘ï¸ åˆ é™¤
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // é…ç½®
    const API_BASE = 'http://localhost:3000/api/scripts';
    let currentScriptId = null;
    let themes = [];
    let eventSource = null;
    
    // ==================== ç»ˆç«¯æ—¥å¿—åŠŸèƒ½ ====================
    
    function getTimestamp() {
      const now = new Date();
      return now.toTimeString().split(' ')[0];
    }
    
    function terminalLog(message, type = 'info') {
      const terminal = document.getElementById('terminal-output');
      const line = document.createElement('div');
      line.className = `terminal-line ${type}`;
      
      const timestamp = `[${getTimestamp()}]`;
      line.innerHTML = `<span class="timestamp">${timestamp}</span> ${escapeHtml(message)}`;
      
      terminal.appendChild(line);
      terminal.scrollTop = terminal.scrollHeight;
    }
    
    function terminalLogAI(content) {
      const terminal = document.getElementById('terminal-output');
      const line = document.createElement('div');
      line.className = 'terminal-line ai';
      line.innerHTML = `<span class="timestamp">[${getTimestamp()}]</span> ğŸ¤– AI: ${escapeHtml(content.substring(0, 200))}${content.length > 200 ? '...' : ''}`;
      terminal.appendChild(line);
      terminal.scrollTop = terminal.scrollHeight;
    }
    
    function terminalLogStep(step, description) {
      const terminal = document.getElementById('terminal-output');
      
      // æ·»åŠ åˆ†éš”çº¿
      const separator = document.createElement('div');
      separator.className = 'terminal-line';
      separator.innerHTML = 'â”€'.repeat(50);
      terminal.appendChild(separator);
      
      // æ·»åŠ æ­¥éª¤ä¿¡æ¯
      const line = document.createElement('div');
      line.className = 'terminal-line step';
      line.innerHTML = `<span class="timestamp">[${getTimestamp()}]</span> ğŸ“ Step ${step}: ${escapeHtml(description)}`;
      terminal.appendChild(line);
      terminal.scrollTop = terminal.scrollHeight;
    }
    
    function clearTerminal() {
      const terminal = document.getElementById('terminal-output');
      terminal.innerHTML = `
        <div class="terminal-line timestamp">[${getTimestamp()}] ç»ˆç«¯å·²æ¸…ç©º</div>
        <div class="terminal-line info">ğŸ’¡ ç­‰å¾…æ–°çš„ç”Ÿæˆä»»åŠ¡...</div>
        <div class="terminal-line"></div>
        <div class="terminal-line"><span class="terminal-cursor"></span></div>
      `;
    }
    
    function copyTerminalContent() {
      const terminal = document.getElementById('terminal-output');
      const text = terminal.innerText;
      navigator.clipboard.writeText(text).then(() => {
        terminalLog('ğŸ“‹ æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      }).catch(err => {
        terminalLog('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
      });
    }
    
    function updateProgressBar(step) {
      const progressBar = document.getElementById('progress-bar');
      const progressStep = document.getElementById('progress-step');
      const percentage = (step / 10) * 100;
      if (progressBar) {
        progressBar.style.width = percentage + '%';
      }
      if (progressStep) {
        progressStep.textContent = `æ­¥éª¤ ${step}/10`;
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      await loadThemes();
      await loadStats();
      await loadScripts();
      showPage('dashboard');
    });
    
    // é¡µé¢åˆ‡æ¢
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById(`page-${pageName}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('bg-purple-600/50');
        if (link.dataset.page === pageName) {
          link.classList.add('bg-purple-600/50');
        }
      });
    }
    
    // åŠ è½½ä¸»é¢˜
    async function loadThemes() {
      try {
        const res = await fetch(`${API_BASE}/themes`);
        const data = await res.json();
        themes = data.themes || [];
        
        // æ¸²æŸ“ä¸»é¢˜é€‰é¡¹
        const themeOptions = document.getElementById('theme-options');
        const filterTheme = document.getElementById('filter-theme');
        
        themeOptions.innerHTML = themes.map((t, i) => `
          <label class="theme-option cursor-pointer">
            <input type="radio" name="theme" value="${t.id}" ${i === 0 ? 'checked' : ''} class="hidden">
            <div class="p-4 rounded-lg border-2 border-gray-600 hover:border-purple-500 transition theme-card">
              <div class="text-lg font-bold">${t.name}</div>
              <div class="text-sm text-gray-400 mt-1">${t.description}</div>
            </div>
          </label>
        `).join('');
        
        // æ·»åŠ æ ·å¼åˆ‡æ¢
        document.querySelectorAll('.theme-option input').forEach(input => {
          input.addEventListener('change', () => {
            document.querySelectorAll('.theme-card').forEach(card => card.classList.remove('border-purple-500'));
            input.parentElement.querySelector('.theme-card').classList.add('border-purple-500');
          });
          if (input.checked) {
            input.parentElement.querySelector('.theme-card').classList.add('border-purple-500');
          }
        });
        
        filterTheme.innerHTML = '<option value="">å…¨éƒ¨ä¸»é¢˜</option>' + 
          themes.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        
        // æ¸²æŸ“æ¨¡æ¿é¡µé¢
        renderTemplates();
      } catch (error) {
        console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
      }
    }
    
    // æ¸²æŸ“æ¨¡æ¿åˆ—è¡¨
    function renderTemplates() {
      const container = document.getElementById('templates-list');
      container.innerHTML = themes.map(t => `
        <div class="card rounded-xl p-6 border border-gray-700">
          <h3 class="text-xl font-bold mb-2">${t.name}</h3>
          <p class="text-gray-400 mb-4">${t.description}</p>
          <p class="text-sm text-purple-400">${t.atmosphere}</p>
          <button onclick="quickGenerate('${t.id}')" class="mt-4 w-full btn-primary py-2 rounded-lg font-bold">
            ä½¿ç”¨æ­¤ä¸»é¢˜ç”Ÿæˆ
          </button>
        </div>
      `).join('');
    }
    
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/stats/overview`);
        const data = await res.json();
        
        if (data.success) {
          document.getElementById('stat-total').textContent = data.stats.totalScripts;
          document.getElementById('stat-published').textContent = data.stats.publishedScripts;
          document.getElementById('stat-draft').textContent = data.stats.draftScripts;
          document.getElementById('stat-plays').textContent = data.stats.totalPlayCount;
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
      }
    }
    
    // åŠ è½½å‰§æœ¬åˆ—è¡¨
    async function loadScripts() {
      try {
        const status = document.getElementById('filter-status')?.value || '';
        const theme = document.getElementById('filter-theme')?.value || '';
        
        let url = `${API_BASE}?`;
        if (status) url += `status=${status}&`;
        if (theme) url += `theme=${theme}&`;
        
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
          renderScripts(data.scripts);
          renderRecentScripts(data.scripts.slice(0, 5));
        }
      } catch (error) {
        console.error('åŠ è½½å‰§æœ¬å¤±è´¥:', error);
        document.getElementById('scripts-list').innerHTML = '<p class="text-red-400">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIè¿æ¥</p>';
      }
    }
    
    // æ¸²æŸ“å‰§æœ¬åˆ—è¡¨
    function renderScripts(scripts) {
      const container = document.getElementById('scripts-list');
      
      if (scripts.length === 0) {
        container.innerHTML = '<p class="text-gray-400">æš‚æ— å‰§æœ¬ï¼Œç‚¹å‡»"ç”Ÿæˆå‰§æœ¬"åˆ›å»ºç¬¬ä¸€ä¸ªï¼</p>';
        return;
      }
      
      container.innerHTML = scripts.map(s => `
        <div class="card rounded-xl p-6 border border-gray-700 cursor-pointer hover:border-purple-500 transition" 
             onclick="viewScript('${s.id}')">
          <div class="flex justify-between items-start mb-3">
            <h3 class="text-xl font-bold">${s.title}</h3>
            <span class="status-${s.status} text-sm">${getStatusText(s.status)}</span>
          </div>
          <p class="text-gray-400 text-sm mb-3">${s.description || 'æš‚æ— æè¿°'}</p>
          <div class="flex gap-2 flex-wrap mb-3">
            <span class="tag bg-purple-600/50">${getThemeName(s.theme)}</span>
            <span class="tag bg-blue-600/50">${s.min_players}-${s.max_players}äºº</span>
            <span class="tag bg-yellow-600/50">éš¾åº¦${s.difficulty}</span>
          </div>
          <div class="text-xs text-gray-500">
            åˆ›å»ºäº ${new Date(s.created_at).toLocaleDateString()}
            ${s.play_count > 0 ? ` Â· ${s.play_count}æ¬¡æ¸¸ç©` : ''}
          </div>
        </div>
      `).join('');
    }
    
    // æ¸²æŸ“æœ€è¿‘å‰§æœ¬
    function renderRecentScripts(scripts) {
      const container = document.getElementById('recent-scripts');
      
      if (scripts.length === 0) {
        container.innerHTML = '<p class="text-gray-400">æš‚æ— å‰§æœ¬</p>';
        return;
      }
      
      container.innerHTML = scripts.map(s => `
        <div class="flex justify-between items-center p-3 rounded-lg hover:bg-gray-700/50 cursor-pointer" 
             onclick="viewScript('${s.id}')">
          <div>
            <div class="font-bold">${s.title}</div>
            <div class="text-sm text-gray-400">${getThemeName(s.theme)} Â· ${s.min_players}-${s.max_players}äºº</div>
          </div>
          <span class="status-${s.status} text-sm">${getStatusText(s.status)}</span>
        </div>
      `).join('');
    }
    
    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
      const map = { draft: 'è‰ç¨¿', ready: 'å¾…å‘å¸ƒ', published: 'å·²å‘å¸ƒ' };
      return map[status] || status;
    }
    
    // è·å–ä¸»é¢˜åç§°
    function getThemeName(themeId) {
      const theme = themes.find(t => t.id === themeId);
      return theme?.name || themeId;
    }
    
    // æ›´æ–°ç©å®¶äººæ•°æ˜¾ç¤º
    function updatePlayerCount(value) {
      document.getElementById('player-count-display').textContent = value + 'äºº';
    }
    
    // é€‰æ‹©éš¾åº¦
    function selectDifficulty(level) {
      document.getElementById('difficulty').value = level;
      document.querySelectorAll('.difficulty-btn').forEach((btn, i) => {
        btn.classList.remove('bg-purple-600');
        btn.classList.add('bg-gray-700');
        if (i + 1 === level) {
          btn.classList.remove('bg-gray-700');
          btn.classList.add('bg-purple-600');
        }
      });
    }
    
    // ç”Ÿæˆå‰§æœ¬ (ä½¿ç”¨ SSE æµå¼ä¼ è¾“)
    async function generateScript(event) {
      event.preventDefault();
      
      const theme = document.querySelector('input[name="theme"]:checked')?.value;
      const playerCount = parseInt(document.getElementById('player-count').value);
      const difficulty = parseInt(document.getElementById('difficulty').value);
      const title = document.getElementById('custom-title').value || null;
      const customBackground = document.getElementById('custom-background').value || null;
      
      // æ¸…ç©ºå¹¶åˆå§‹åŒ–ç»ˆç«¯
      const terminal = document.getElementById('terminal-output');
      terminal.innerHTML = '';
      terminalLog('ğŸš€ å¼€å§‹ç”Ÿæˆå‰§æœ¬...', 'info');
      terminalLog(`ä¸»é¢˜: ${getThemeName(theme)} | ç©å®¶: ${playerCount}äºº | éš¾åº¦: ${difficulty}`, 'info');
      terminalLog('', 'info');
      
      // æ˜¾ç¤ºè¿›åº¦
      document.getElementById('generate-btn').disabled = true;
      document.getElementById('generate-progress').classList.remove('hidden');
      document.getElementById('progress-text').textContent = 'æ­£åœ¨ç”Ÿæˆå‰§æœ¬...è¿™å¯èƒ½éœ€è¦1-2åˆ†é’Ÿ';
      
      // å…³é—­ä¹‹å‰çš„ SSE è¿æ¥
      if (eventSource) {
        eventSource.close();
      }
      
      try {
        // æ„å»º SSE URL
        const params = new URLSearchParams({
          theme,
          playerCount: playerCount.toString(),
          difficulty: difficulty.toString(),
          stream: 'true'
        });
        if (title) params.append('title', title);
        if (customBackground) params.append('customBackground', customBackground);
        
        eventSource = new EventSource(`${API_BASE}/generate/stream?${params.toString()}`);
        
        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          
          switch (data.type) {
            case 'start':
              terminalLog(`ğŸ“‹ ä»»åŠ¡ID: ${data.taskId}`, 'info');
              updateProgressBar(0);
              break;
              
            case 'step':
              terminalLogStep(data.step, data.description);
              document.getElementById('progress-text').textContent = 
                `æ­¥éª¤ ${data.step}/10: ${data.description}`;
              updateProgressBar(data.step);
              break;
              
            case 'ai_request':
              terminalLog(`ğŸ”„ å‘é€AIè¯·æ±‚: ${data.action}`, 'info');
              break;
              
            case 'ai_response':
              terminalLogAI(data.content);
              break;
              
            case 'progress':
              terminalLog(`âœ… ${data.message}`, 'success');
              break;
              
            case 'warning':
              terminalLog(`âš ï¸ ${data.message}`, 'warning');
              break;
              
            case 'error':
              terminalLog(`âŒ ${data.message}`, 'error');
              break;
              
            case 'complete':
              terminalLog('', 'info');
              terminalLog('ğŸ‰ å‰§æœ¬ç”Ÿæˆå®Œæˆï¼', 'success');
              terminalLog(`å‰§æœ¬ID: ${data.scriptId}`, 'info');
              terminalLog(`æ ‡é¢˜: ${data.title}`, 'info');
              updateProgressBar(10);
              eventSource.close();
              eventSource = null;
              
              // æ›´æ–°UI
              document.getElementById('generate-btn').disabled = false;
              document.getElementById('generate-progress').classList.add('hidden');
              loadStats();
              loadScripts();
              viewScript(data.scriptId);
              break;
          }
        };
        
        eventSource.onerror = (error) => {
          console.error('SSE é”™è¯¯:', error);
          terminalLog('âŒ è¿æ¥ä¸­æ–­ï¼Œåˆ‡æ¢åˆ°æ™®é€šæ¨¡å¼...', 'error');
          eventSource.close();
          eventSource = null;
          
          // é™çº§åˆ°æ™®é€šè¯·æ±‚
          fallbackGenerate(theme, playerCount, difficulty, title, customBackground);
        };
        
      } catch (error) {
        console.error('ç”Ÿæˆå¤±è´¥:', error);
        terminalLog(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
        document.getElementById('generate-btn').disabled = false;
        document.getElementById('generate-progress').classList.add('hidden');
      }
    }
    
    // é™çº§ï¼šæ™®é€šè¯·æ±‚æ¨¡å¼
    async function fallbackGenerate(theme, playerCount, difficulty, title, customBackground) {
      terminalLog('ä½¿ç”¨æ™®é€šæ¨¡å¼ç”Ÿæˆ...', 'warning');
      
      try {
        const res = await fetch(`${API_BASE}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ theme, playerCount, difficulty, title, customBackground })
        });
        
        const data = await res.json();
        
        if (data.success) {
          terminalLog('ğŸ‰ å‰§æœ¬ç”Ÿæˆå®Œæˆï¼', 'success');
          await loadStats();
          await loadScripts();
          viewScript(data.script.id);
        } else {
          terminalLog(`âŒ ç”Ÿæˆå¤±è´¥: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('ç”Ÿæˆå¤±è´¥:', error);
        terminalLog(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
      } finally {
        document.getElementById('generate-btn').disabled = false;
        document.getElementById('generate-progress').classList.add('hidden');
      }
    }
    
    // å¿«é€Ÿç”Ÿæˆ
    function quickGenerate(themeId) {
      showPage('generate');
      const radio = document.querySelector(`input[name="theme"][value="${themeId}"]`);
      if (radio) {
        radio.checked = true;
        radio.dispatchEvent(new Event('change'));
      }
    }
    
    // æŸ¥çœ‹å‰§æœ¬è¯¦æƒ…
    async function viewScript(scriptId) {
      currentScriptId = scriptId;
      
      try {
        const res = await fetch(`${API_BASE}/${scriptId}?full=true`);
        const data = await res.json();
        
        if (data.success) {
          renderScriptModal(data.script);
          document.getElementById('script-modal').classList.add('active');
        }
      } catch (error) {
        console.error('è·å–è¯¦æƒ…å¤±è´¥:', error);
        alert('è·å–è¯¦æƒ…å¤±è´¥');
      }
    }
    
    // æ¸²æŸ“å‰§æœ¬è¯¦æƒ…æ¨¡æ€æ¡†
    function renderScriptModal(script) {
      document.getElementById('modal-title').textContent = script.title;
      
      const content = document.getElementById('modal-content');
      content.innerHTML = `
        <div class="space-y-6">
          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <div>
            <h4 class="text-lg font-bold mb-2">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div><span class="text-gray-400">çŠ¶æ€:</span> <span class="status-${script.status}">${getStatusText(script.status)}</span></div>
              <div><span class="text-gray-400">ä¸»é¢˜:</span> ${getThemeName(script.theme)}</div>
              <div><span class="text-gray-400">ç©å®¶äººæ•°:</span> ${script.min_players}-${script.max_players}äºº</div>
              <div><span class="text-gray-400">éš¾åº¦:</span> ${'â­'.repeat(script.difficulty)}</div>
              <div><span class="text-gray-400">é¢„è®¡æ—¶é•¿:</span> ${script.estimated_duration}åˆ†é’Ÿ</div>
              <div><span class="text-gray-400">æ¸¸ç©æ¬¡æ•°:</span> ${script.play_count}</div>
            </div>
            ${script.description ? `<p class="mt-3 text-gray-300">${script.description}</p>` : ''}
          </div>
          
          <!-- æ¡ˆä»¶çœŸç›¸ -->
          ${script.truth ? `
          <div>
            <h4 class="text-lg font-bold mb-2">ğŸ” æ¡ˆä»¶çœŸç›¸ <span class="text-red-400 text-sm">(å‰§é€)</span></h4>
            <div class="bg-red-900/20 border border-red-800/50 rounded-lg p-4 text-sm">
              <p><span class="text-gray-400">å—å®³è€…:</span> ${script.truth.victim_name}</p>
              <p><span class="text-gray-400">ä½œæ¡ˆåŠ¨æœº:</span> ${script.truth.murder_motive}</p>
              <p><span class="text-gray-400">ä½œæ¡ˆæ‰‹æ³•:</span> ${script.truth.murder_method}</p>
              <p class="mt-2">${script.truth.full_truth}</p>
            </div>
          </div>
          ` : ''}
          
          <!-- è§’è‰²åˆ—è¡¨ -->
          <div>
            <h4 class="text-lg font-bold mb-2">ğŸ‘¥ è§’è‰² (${script.characters?.length || 0})</h4>
            <div class="grid grid-cols-2 gap-3">
              ${(script.characters || []).map(c => `
                <div class="bg-gray-800/50 rounded-lg p-3 ${c.is_murderer ? 'border border-red-500' : ''}">
                  <div class="font-bold">${c.name} ${c.is_murderer ? 'ğŸ”ª' : ''}</div>
                  <div class="text-sm text-gray-400">${c.occupation || c.character_type}</div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- ç« èŠ‚ -->
          <div>
            <h4 class="text-lg font-bold mb-2">ğŸ“– ç« èŠ‚ (${script.chapters?.length || 0})</h4>
            <div class="space-y-2">
              ${(script.chapters || []).map(c => `
                <div class="bg-gray-800/50 rounded-lg p-3">
                  <div class="font-bold">ç¬¬${c.chapter_number}ç« : ${c.title}</div>
                  <div class="text-sm text-gray-400">${c.chapter_goal}</div>
                  <div class="text-xs text-purple-400 mt-1">è°œé¢˜: ${c.puzzles?.length || 0}ä¸ª</div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- çº¿ç´¢å’Œåœ°ç‚¹ -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <h4 class="text-lg font-bold mb-2">ğŸ”‘ çº¿ç´¢ (${script.clues?.length || 0})</h4>
              <div class="space-y-1 max-h-40 overflow-y-auto text-sm">
                ${(script.clues || []).slice(0, 10).map(c => `
                  <div class="py-1">${c.is_key_evidence ? 'â­' : 'â€¢'} ${c.clue_name}</div>
                `).join('')}
              </div>
            </div>
            <div>
              <h4 class="text-lg font-bold mb-2">ğŸ“ åœ°ç‚¹ (${script.locations?.length || 0})</h4>
              <div class="space-y-1 max-h-40 overflow-y-auto text-sm">
                ${(script.locations || []).map(l => `
                  <div class="py-1">â€¢ ${l.name}</div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
      
      // æ›´æ–°å‘å¸ƒæŒ‰é’®çŠ¶æ€
      const btnPublish = document.getElementById('btn-publish');
      if (script.is_published) {
        btnPublish.textContent = 'âœ… å·²å‘å¸ƒ';
        btnPublish.disabled = true;
        btnPublish.classList.add('opacity-50');
      } else {
        btnPublish.textContent = 'ğŸš€ å‘å¸ƒå‰§æœ¬';
        btnPublish.disabled = false;
        btnPublish.classList.remove('opacity-50');
      }
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
      document.getElementById('script-modal').classList.remove('active');
      currentScriptId = null;
    }
    
    // å‘å¸ƒå‰§æœ¬
    async function publishScript() {
      if (!currentScriptId) return;
      
      if (!confirm('ç¡®å®šè¦å‘å¸ƒæ­¤å‰§æœ¬å—ï¼Ÿå‘å¸ƒåå°†å¯ä»¥åœ¨æ¸¸æˆä¸­ä½¿ç”¨ã€‚')) return;
      
      try {
        const res = await fetch(`${API_BASE}/${currentScriptId}/publish`, {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          alert('å‘å¸ƒæˆåŠŸï¼');
          closeModal();
          await loadStats();
          await loadScripts();
        } else {
          alert('å‘å¸ƒå¤±è´¥: ' + (data.errors?.join(', ') || data.error));
        }
      } catch (error) {
        alert('å‘å¸ƒå¤±è´¥: ' + error.message);
      }
    }
    
    // å¯¼å‡ºå‰§æœ¬
    function exportScript() {
      if (!currentScriptId) return;
      window.open(`${API_BASE}/${currentScriptId}/export`, '_blank');
    }
    
    // åˆ é™¤å‰§æœ¬
    async function deleteScript() {
      if (!currentScriptId) return;
      
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å‰§æœ¬å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
      
      try {
        const res = await fetch(`${API_BASE}/${currentScriptId}`, {
          method: 'DELETE'
        });
        const data = await res.json();
        
        if (data.success) {
          alert('åˆ é™¤æˆåŠŸ');
          closeModal();
          await loadStats();
          await loadScripts();
        } else {
          alert('åˆ é™¤å¤±è´¥: ' + data.error);
        }
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('script-modal').addEventListener('click', (e) => {
      if (e.target.id === 'script-modal') {
        closeModal();
      }
    });
  </script>
</body>
</html>
